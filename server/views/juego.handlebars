<div class="game-page-container">
  <!-- Header Controls -->
  <div class="game-header-controls">
    <div class="game-info-badge">
      <span class="badge-label">Saldo</span>
      <span class="badge-value">${{saldo}}</span>
    </div>
    <div class="game-info-badge bet-total">
      <span class="badge-label">Apuesta Total</span>
      <span class="badge-value">$0</span>
    </div>
    <button class="spin-button">Girar Ruleta</button>
  </div>

  <!-- Content Wrapper -->
  <div class="game-content-wrapper">
    <!-- Sidebar de Estadísticas -->
    <div class="game-sidebar">
      <div class="stat-card">
        <h3 class="stat-title">Estado de Juego</h3>
        <div class="stat-status active">Recibiendo Apuestas</div>
      </div>

      <div class="stat-card">
        <h3 class="stat-title">Últimos 5 Números</h3>
        <ul class="stat-list">
          <!-- <li class="stat-item red">27 <span class="color-label">Rojo</span></li> -->
        </ul>
      </div>

      <div class="stat-card">
        <h3 class="stat-title">Últimas 5 Apuestas</h3>
        <ul class="stat-list">
          <!-- <li class="bet-item loss">Rojo - $100.000 <span class="bet-result">Derrota</span></li> -->
        </ul>
      </div>
    </div>

    <!-- Betting Controls in Left Sidebar -->
    <div class="betting-controls-wrapper">
      <!-- Tipo de Apuesta -->
      <div class="bet-type-selector">
        <h4>Tipo de Apuesta</h4>
        <div class="bet-type-buttons">
          <button
            class="bet-type-btn active"
            data-type="numero"
            data-label="Número"
          >
            Número Específico (35:1)
          </button>
          <button class="bet-type-btn" data-type="rojo" data-label="Rojo">
            Rojo (1:1)
          </button>
          <button class="bet-type-btn" data-type="negro" data-label="Negro">
            Negro (1:1)
          </button>
          <button class="bet-type-btn" data-type="par" data-label="Par">
            Par (1:1)
          </button>
          <button class="bet-type-btn" data-type="impar" data-label="Impar">
            Impar (1:1)
          </button>
        </div>

        <div id="numero-input" class="numero-selector">
          <label>Seleccionar Número (0-36)</label>
          <input
            type="number"
            id="numero-apuesta"
            min="0"
            max="36"
            value="0"
          />
        </div>
      </div>
    </div>

    <!-- Monto de Apuesta (separate wrapper) -->
    <div class="bet-amount-wrapper">
      <div class="bet-input-container">
        <label for="bet-amount" class="bet-label">Monto de Apuesta</label>
        <div class="bet-input-wrapper">
          <span class="currency-symbol">$</span>
          <input
            type="number"
            id="bet-amount"
            class="bet-input"
            placeholder="0"
            min="1"
            step="1"
            value="100"
          />
        </div>
        <div class="quick-bet-buttons">
          <button class="quick-bet-btn" data-amount="100">$100</button>
          <button class="quick-bet-btn" data-amount="500">$500</button>
          <button class="quick-bet-btn" data-amount="1000">$1,000</button>
          <button class="quick-bet-btn" data-amount="5000">$5,000</button>
        </div>
      </div>
    </div>

    <!-- Contenedor Principal del Juego -->
    <div class="game-main-container">
      <div class="roulette-wrap">
        <div class="pointer" aria-hidden="true"></div>
        <div
          id="wheel"
          class="wheel"
          role="img"
          aria-label="Ruleta europea"
        ></div>
      </div>
    </div>
  </div>
</div>

<script src="/js/ruleta.js"></script>

<script>
  let tipoApuestaActual = 'numero';
  let valorApuesta = 0;
  let apuestaActualId = null;

  const wheel = document.getElementById('wheel');
  const spinBtn = document.querySelector('.spin-button');
  const statusEl = document.querySelector('.stat-status');
  const betInput = document.getElementById('bet-amount');
  const saldoElement = document.querySelector('.badge-value');
  
  paintWheel();
  drawLabels();

  // Selección de tipo de apuesta
  document.querySelectorAll('.bet-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.bet-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tipoApuestaActual = btn.dataset.type;
      
      // Mostrar u ocultar el selector de número
      const numeroInput = document.getElementById('numero-input');
      numeroInput.style.display = (tipoApuestaActual === 'numero') ? 'block' : 'none';
    });
  });

  // Modificar la función spin
  async function spin() {
    if (spinning) return;
    
    const monto = parseInt(betInput.value);
    if (!monto || monto <= 0) {
      alert('Ingresa un monto válido');
      return;
    }
    
    // Obtener valor de la apuesta según tipo
    if (tipoApuestaActual === 'numero') {
      valorApuesta = parseInt(document.getElementById('numero-apuesta').value);
    } else {
      valorApuesta = tipoApuestaActual; // 'rojo', 'negro', etc.
    }
    
    // Crear apuesta en el servidor
    try {
      const response = await fetch('/apuesta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          monto: monto,
          tipoApuesta: tipoApuestaActual,
          valor: valorApuesta
        })
      });
      
      const data = await response.json();
      
      if (!data.success) {
        alert(data.error || 'Error al realizar apuesta');
        return;
      }
      
      apuestaActualId = data.apuestaId;
      saldoElement.textContent = `$${data.nuevoSaldo}`;
      
      // Ahora sí girar la ruleta
      spinning = true;
      spinBtn.disabled = true;
      statusEl.textContent = 'Girando…';

      const extraTurns = (Math.floor(Math.random()*4) + 4) * 360;
      const randomAngle = Math.floor(Math.random() * 360);
      const duration = (Math.random() * (5 - 3) + 3).toFixed(2);

      currentRotation += (extraTurns + randomAngle);
      wheel.style.transition = `transform ${duration}s cubic-bezier(.12,.63,.16,1)`;
      wheel.style.transform = `rotate(${currentRotation}deg)`;

      wheel.addEventListener('transitionend', onEnd, { once:true });
      
    } catch (error) {
      alert('Error de conexión');
      console.error(error);
    }
  }

  async function onEnd() {
    currentRotation = ((currentRotation % 360) + 360) % 360;
    const idx = indexAtPointer(currentRotation);
    const numeroGanador = numbersCW[idx];

    // Marcar visualmente
    const labels = wheel.querySelectorAll('.label');
    if (lastWinIdx !== null && labels[lastWinIdx]) 
      labels[lastWinIdx].classList.remove('win');
    if (labels[idx]) labels[idx].classList.add('win');
    lastWinIdx = idx;

    showResult(numeroGanador);

    // Enviar resultado al servidor
    try {
      const response = await fetch('/resultado-apuesta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          apuestaId: apuestaActualId,
          numeroGanador: numeroGanador
        })
      });
      
      const data = await response.json();
      
      if (data.gano) {
        statusEl.innerHTML += ` <span style="color: #4ade80;">¡GANASTE $${data.pago}!</span>`;
      } else {
        statusEl.innerHTML += ` <span style="color: #ef4444;">Perdiste</span>`;
      }
      
      saldoElement.textContent = `$${data.nuevoSaldo}`;
      
      // Actualizar listas de últimos números y apuestas
      actualizarHistorial(numeroGanador, data.gano, parseInt(betInput.value));
      
    } catch (error) {
      console.error('Error al procesar resultado:', error);
    }

    spinning = false;
    spinBtn.disabled = false;
    wheel.style.transition = 'none';
    wheel.style.transform = `rotate(${currentRotation}deg)`;
    void wheel.offsetWidth;
  }

  function actualizarHistorial(numero, gano, monto) {
    // Actualizar últimos 5 números
    const numerosLista = document.querySelector('.stat-card:nth-child(2) .stat-list');
    const color = (numero===0) ? 'green' : (isRed(numero) ? 'red' : 'black');
    const colorLabel = (numero===0) ? 'Verde' : (isRed(numero) ? 'Rojo' : 'Negro');
    
    const li = document.createElement('li');
    li.className = `stat-item ${color}`;
    li.innerHTML = `${numero} <span class="color-label">${colorLabel}</span>`;
    numerosLista.insertBefore(li, numerosLista.firstChild);
    
    // Mantener solo 5
    while (numerosLista.children.length > 5) {
      numerosLista.removeChild(numerosLista.lastChild);
    }
    
    // Actualizar últimas 5 apuestas
    const apuestasLista = document.querySelector('.stat-card:nth-child(3) .stat-list');
    const li2 = document.createElement('li');
    li2.className = `bet-item ${gano ? 'win' : 'loss'}`;
    li2.innerHTML = `${tipoApuestaActual} - $${monto} <span class="bet-result">${gano ? 'Victoria' : 'Derrota'}</span>`;
    apuestasLista.insertBefore(li2, apuestasLista.firstChild);
    
    while (apuestasLista.children.length > 5) {
      apuestasLista.removeChild(apuestasLista.lastChild);
    }
  }

  spinBtn.addEventListener('click', spin);

  // Quick bet buttons
  document.querySelectorAll('.quick-bet-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const amount = parseInt(btn.getAttribute('data-amount'));
      const currentValue = parseInt(betInput.value) || 0;
      betInput.value = currentValue + amount;
    });
  });
</script>